services:
  postgres:
    restart: always
    container_name: postgres
    hostname: postgres
    build:
      context: ./db/engine/postgres
      dockerfile: Dockerfile
    ports:
      - ${POSTGRES_FRONT_PORT}:${POSTGRES_BACK_PORT}
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    user: root
    volumes:
      - ./db/engine/postgres/initdb.d:/docker-entrypoint-initdb.d
      - ./db/engine/postgres/data:/var/lib/postgres/data

  redis:
    restart: always
    container_name: redis
    build:
      context: ./db/engine/redis
      dockerfile: Dockerfile
    ports:
      - '6739:6739'
    volumes:
      - ./db/engine/redis/data:/data

  backend:
    restart: always
    build:
      context: ./backend
      dockerfile: build/Dockerfile
    container_name: backend
    volumes:
      - ./backend:/go/src/backend
    ports:
      - ${GO_ECHO_PORT}:${GO_ECHO_PORT}
      - ${GRPC_PORT}:${GRPC_PORT}
      - '2345:2345' # デバッグポート
    security_opt:
      - 'seccomp:unconfined' # デバッガに必要
    cap_add:
      - SYS_PTRACE # デバッガに必要
    environment:
      - GOPATH=${GOPATH}
      - DEBUG_MODE=${DEBUG_MODE:-false}
    # tty: true
    stdin_open: true
    links:
      - redis
      - postgres
    depends_on:
      - redis
      - postgres
